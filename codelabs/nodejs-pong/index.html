
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Build a public endpoint using Node.js</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
<script src="https://aardwolf.relaycorp.tech/script.js" data-site="TBSIELNB" defer></script>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="nodejs-pong"
                  title="Build a public endpoint using Node.js"
                  environment="web"
                  feedback-link="https://github.com/AwalaNetwork/codelabs">
    
      <google-codelab-step label="Overview" duration="10">
        <p>An <em>Awala service</em> is a collection of mobile, desktop, server-side and/or CLI apps that exchange mutually-intelligible messages using <em>endpoints</em>. Server-side apps exposed as Internet hosts will have <em>public endpoints</em> (e.g., <code>your-service.com</code>), whilst all other apps (e.g., mobile, desktop) will have <em>private endpoints</em>.</p>
<p>You&#39;re going to work with the <a href="https://specs.awala.network/RS-014" target="_blank">Awala Ping</a> service in this codelab. Ping is a trivial service used to test Awala itself by having private endpoints send <em>pings</em> to other endpoints and getting <em>pongs</em> in response. The recipient of the ping can be public or private, but here you&#39;ll only use a public endpoint.</p>
<h2 is-upgraded>What you&#39;ll build</h2>
<p>You&#39;ll build a <a href="https://www.fastify.io" target="_blank">Fastify</a>-powered HTTP server that will act as a public endpoint in the Ping service, and you&#39;ll deploy it to <a href="https://cloud.google.com/appengine" target="_blank">Google App Engine</a> (GAE).</p>
<p>Say your public endpoint address is <code>ping.awala.services</code> and a private endpoint in an Android app sends you a ping, as illustrated in the picture below. When the private endpoint sends the ping, the message will pass through the <em>private gateway</em> on the Android/desktop device, then on to a public gateway (such as <code>frankfurt.relaycorp.cloud</code>), and it&#39;ll finally arrive at your public endpoint.</p>
<p class="image-container"><img src="img/e365b8401314ec6a.png"></p>
<p>On the other hand, pong messages do the same route in reverse:</p>
<p class="image-container"><img src="img/e49a74cb42c3ed18.png"></p>
<p>Awala requires messages bound for private endpoints to be pre-authorised by the recipient, so each ping message includes an authorisation for the recipient (e.g., <code>ping.awala.services</code>) to reply with a pong message. In most services, authorisations would be issued once and renewed periodically, but public endpoints in the Ping service are meant to be stateless, so private endpoints have to issue an authorisation each time.</p>
<p>Positive : The Ping service uses a request-response pattern because its sole purpose is to test that endpoints can send and receive data. However, <strong>endpoints in your own services can send messages at any time</strong> and there&#39;s no requirement to respond to messages. Your endpoints should just push data to their peers whenever new data is available, without waiting for anyone else to &#34;initiate&#34; the communication.</p>
<h2 is-upgraded>What you&#39;ll need</h2>
<ul>
<li>A very basic understanding of Node.js, HTTP and DNS.</li>
<li><a href="https://nodejs.org/en/download/" target="_blank">Node.js</a> 14+. We&#39;ll assume that <code>npm</code>, <code>npx</code> and <code>node</code> are in your <code>$PATH</code>.</li>
<li>A <a href="https://cloud.google.com/" target="_blank">Google Cloud Platform</a> (GCP) account. As of this writing, running this codelab alone won&#39;t exceed your <a href="https://cloud.google.com/appengine/quotas" target="_blank">free quota</a>.</li>
<li>A domain name with DNSSEC enabled and the ability to create SRV records. If you don&#39;t have one already, register a cheap one with your favourite registrar. Alternatively, if you know of a service offering this for free, use it and please <a href="https://github.com/AwalaNetwork/codelabs/issues/5" target="_blank">let us know about it</a>.</li>
<li><a href="https://awala.network/users/download" target="_blank">The private gateway</a>, otherwise known simply as &#34;Awala&#34; in non-technical documents.</li>
</ul>
<h2 is-upgraded>In case you need help</h2>
<p>If you have any issues in the course of this codelab, please post a message on <a href="https://community.awala.network/" target="_blank">our forum</a> and we&#39;ll help you out! You can also check out the <a href="https://github.com/AwalaNetwork/codelabs/tree/main/examples/nodejs-pong" target="_blank">final version of the app you&#39;re going to build</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Set up Google App Engine" duration="10">
        <h2 is-upgraded>Set up a new GCP project</h2>
<ol type="1">
<li><a href="https://console.cloud.google.com/projectcreate" target="_blank">Create a new GCP project</a> and give it any name you&#39;d like.</li>
<li>Make sure that billing is enabled for the project. <a href="https://cloud.google.com/billing/docs/how-to/modify-project" target="_blank">Learn how to confirm that billing is enabled</a>.</li>
<li>Enable the <a href="https://console.cloud.google.com/apis/library/cloudbuild.googleapis.com" target="_blank">Cloud Build API</a>.</li>
</ol>
<h2 is-upgraded>Set up the GCP SDK</h2>
<p><a href="https://cloud.google.com/sdk/docs/install" target="_blank">Install and initialize the GCP SDK</a>, and then make the new project the default:</p>
<pre><code language="language-shell" class="language-shell">gcloud config set project [YOUR_PROJECT_ID]
</code></pre>
<p>Negative : It&#39;s important not to skip the command above if you&#39;re already using GCP. Otherwise, you&#39;ll end up modifying one of your existing projects.</p>
<h2 is-upgraded>Deploy the app template</h2>
<p>You&#39;re now going to deploy a trivial app to GAE to make sure everything is working so far. You&#39;re going to build on this app to implement the public endpoint later.</p>
<p>Start by creating the GAE app for your project in the region of your choosing:</p>
<pre><code language="language-shell" class="language-shell">gcloud app create
</code></pre>
<p>Next, <a href="/examples/nodejs-pong-template.zip" target="_blank">download the app template</a>, unzip it and change into its directory. On Linux and macOS, you can do this with the following commands:</p>
<pre><code language="language-shell" class="language-shell">wget https://codelabs.awala.network/examples/nodejs-pong-template.zip
unzip nodejs-pong-template.zip
cd nodejs-pong-template
</code></pre>
<p>Then install the app and build it:</p>
<pre><code language="language-shell" class="language-shell">npm install
npm run build
</code></pre>
<p>Let&#39;s make sure everything has worked so far by starting the server:</p>
<pre><code language="language-shell" class="language-shell">npm run start:dev
</code></pre>
<p>You should see the message <code>It works!</code> when you open <a href="http://localhost:8080/" target="_blank"><code>http://localhost:8080</code></a>.</p>
<p>That&#39;s great! So now it&#39;s time to deploy the app to GAE, but first quit the server by pressing <code>Ctrl</code>+<code>C</code> (or <code>Cmd</code>+<code>C</code> on macOS), and then run the following:</p>
<pre><code language="language-shell" class="language-shell">gcloud app deploy
</code></pre>
<h2 is-upgraded>Test the app!</h2>
<p>Run the following command to open the app in your browser:</p>
<pre><code language="language-shell" class="language-shell">gcloud app browse
</code></pre>
<p>You should see something like this:</p>
<p class="image-container"><img src="img/9dcc11b9d0c6b89a.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create the SRV record for the endpoint" duration="5">
        <p>You&#39;re about to set up the public address of your endpoint, which is specified with an SRV record.</p>
<p>We don&#39;t need this DNS record just yet, but DNS propagation can sometimes take a while, so it&#39;s best to get it going now.</p>
<h2 is-upgraded>Make sure your domain has DNSSEC properly configured</h2>
<p>Go to <a href="https://dnssec-analyzer.verisignlabs.com" target="_blank">dnssec-analyzer.verisignlabs.com</a> and check that your domain has DNSSEC properly configured. If that&#39;s the case, you&#39;ll see a screen like this:</p>
<p class="image-container"><img src="img/92be9f549f415ae2.png"></p>
<p>If any issues are reported, check the documentation of your DNS hosting provider and/or registrar to resolve them.</p>
<p>Negative : For security reasons, Awala gateways will communicate with your public endpoint if and only if DNS answers have valid DNSSEC signatures.</p>
<h2 is-upgraded>Create the record</h2>
<p>Create an SRV record under the domain you wish to use using the following parameters:</p>
<ul>
<li>Domain name: <code>_awala-pdc._tcp.your-domain.com</code> if you want <code>your-domain.com</code> to be the public address, or <code>_awala-pdc._tcp.subdomain.your-domain.com</code> if you want <code>subdomain.your-domain.com</code> to be the public address. Alternatively, if you have to specify these fields separately, use: <ul>
<li>Service: <code>_awala-pdc</code>.</li>
<li>Protocol: <code>_tcp</code> or TCP.</li>
<li>Name: <code>your-domain.com</code> or <code>subdomain.your-domain.com</code>.</li>
</ul>
</li>
<li>Value: <code>0 5 443 [YOUR-GAE-APP-DOMAIN]</code>. Alternatively, if you have to specify these fields separately, use:</li>
<li>Priority: <code>0</code>.</li>
<li>Weight: <code>5</code>.</li>
<li>Port: <code>443</code>.</li>
<li>Target: Your GAE app domain (e.g., <code>pong-codelab.nw.r.appspot.com</code>).</li>
</ul>
<p>For example, if you were to map the public address <code>pong-codelab.awala.services</code> to <code>https://pong-codelab.nw.r.appspot.com</code> using Cloudflare as the DNS provider, you&#39;d do the following:</p>
<p class="image-container"><img src="img/71e270bfb5a3b6c3.png"></p>
<p>You can use <a href="https://dnschecker.org/#SRV/_awala-pdc._tcp.ping.awala.services" target="_blank">dnschecker.org</a> to monitor the propagation of the new DNS record in a new web browser tab, so that you can continue with the rest of the codelab.</p>
<h2 is-upgraded>Set the public address in the app</h2>
<p>Open <code>app.yaml</code> and add the following:</p>
<pre><code language="language-yaml" class="language-yaml">env_variables:
  PUBLIC_ADDRESS: pong-codelab.awala.services
</code></pre>
<p>Make sure to set <code>PUBLIC_ADDRESS</code> to the right value in your case.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Generate an identity certificate" duration="5">
        <p>Awala requires <em>nodes</em> (i.e., gateways and endpoints) to have long-term <em>identity certificates</em> in order for nodes to authenticate and authorise each other. Consequently, each message must be signed by the sender, and the sender&#39;s certificate must be attached to the message. Additionally, messages bound for private endpoints must contain a <em>certificate chain</em> that includes the recipient&#39;s private gateway certificate.</p>
<p>Whilst this certainly impacts performance, it allows Awala to prevent abuse whilst protecting the privacy of end users in a highly-scalable manner: Nodes can verify that messages are authorised to reach the destination without leaking anything that could identify the human user behind private endpoints – and without having to store any authorisation data.</p>
<p>You&#39;re going to use <a href="https://www.npmjs.com/package/@relaycorp/relaydev" target="_blank"><code>relaydev</code></a> to generate the identity certificate for your endpoint.</p>
<p>Positive : In addition to high-level libraries and tools like <code>relaydev</code>, we&#39;re planning to take things further by <a href="https://github.com/relaycorp/relayverse/issues/28" target="_blank">completely taking the key management off your plate</a>.</p>
<h2 is-upgraded>Generate a key pair</h2>
<p>First, you need to generate the identity key:</p>
<pre><code language="language-shell" class="language-shell">npx @relaycorp/relaydev key gen-rsa &gt; private-key.der
</code></pre>
<p>Negative : You&#39;re about to deploy this app along with the private key above for expediency, but in production you should absolutely use a secret management tool instead. We recommend <a href="https://www.vaultproject.io/" target="_blank">Vault</a> and offer an <a href="https://github.com/relaycorp/keystore-vault-js" target="_blank">official library</a> that integrates seamlessly in Awala.</p>
<h2 is-upgraded>Self-issue a certificate</h2>
<p>Extract the public key from the key pair above:</p>
<pre><code language="language-shell" class="language-shell">npx @relaycorp/relaydev key get-rsa-pub &lt; private-key.der &gt; public-key.der
</code></pre>
<p>Then you can self-issue an identity certificate as shown below. Make sure to use an end date in the future.</p>
<pre><code language="language-shell" class="language-shell">npx @relaycorp/relaydev cert issue \
  --type=endpoint \
  --end-date=2022-01-01 \
  private-key.der \
  &lt; public-key.der &gt; identity-certificate.der
</code></pre>
<p>You won&#39;t need the public key anymore, so you can delete it now:</p>
<pre><code language="language-shell" class="language-shell">rm public-key.der
</code></pre>
<h2 is-upgraded>Serve the certificate</h2>
<p>You&#39;re going to serve the endpoint certificate so that other endpoints can use it to communicate with it. Awala doesn&#39;t currently offer a <a href="https://github.com/AwalaNetwork/specs/issues/30" target="_blank">standard way to distribute such certificates</a>, so you&#39;re just going to make it available at <code>/identity.der</code> in this codelab.</p>
<p>To do this, create the file <code>src/routes/identityCert.ts</code> with the following contents:</p>
<pre><code language="language-typescript" class="language-typescript">import { FastifyInstance } from &#39;fastify&#39;;
import fs from &#39;fs&#39;;
import { dirname, join } from &#39;path&#39;

const ROOT_DIR = dirname(dirname(__dirname));
const CERT_PATH = join(ROOT_DIR, &#39;identity-certificate.der&#39;);

export default async function registerRoutes(
    fastify: FastifyInstance,
    _options: any,
): Promise&lt;void&gt; {
    fastify.route({
        method: [&#39;GET&#39;],
        url: &#39;/identity.der&#39;,
        async handler(_req, reply): Promise&lt;void&gt; {
            const certificate = await fs.promises.readFile(CERT_PATH);
            reply
                .type(&#39;application/vnd.etsi.tsl.der&#39;)
                .send(certificate);
        },
    });
}
</code></pre>
<h2 is-upgraded>Test the new route</h2>
<p>Start the server locally (<code>npm start:dev</code>) and check that the new route is working as expected by checking the certificate it outputs. On Linux/macOS you can run the following:</p>
<pre><code language="language-shell" class="language-shell">curl -s http://127.0.0.1:8080/identity.der | npx @relaycorp/relaydev cert inspect
</code></pre>
<p>You should see an output like this:</p>
<pre><code>Common Name: 0224281a7b5bcf0aa0db4b48baf43b6f03905bc884fd9483ee6445a900f255fea
Private address: 0224281a7b5bcf0aa0db4b48baf43b6f03905bc884fd9483ee6445a900f255fea
Certificate is valid

Use `openssl` to get the full details:
openssl x509 -noout -text -inform DER -in /path/to/cert.der
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Process incoming pings" duration="10">
        <p>You&#39;ve now completed the groundwork, so it&#39;s time to start receiving pings!</p>
<p>Pings are JSON-serialised messages that contain a unique identifier and a <em>Parcel Delivery Authorisation</em> (PDA). The PDA is a certificate that authorises your endpoint to send a pong message to the private endpoint that sent the ping. The structure of ping messages is illustrated below:</p>
<pre><code language="language-json" class="language-json">{
  &#34;id&#34;: &#34;&lt;The ping id&gt;&#34;,
  &#34;pda&#34;: &#34;&lt;The PDA for the recipient (base64-encoded)&gt;&#34;,
  &#34;pda_chain&#34;: [
    &#34;&lt;PDA Chain, Certificate #1 (base64-encoded)&gt;&#34;,
    &#34;...&#34;
  ]
}
</code></pre>
<p>Using Awala&#39;s nomenclature, each ping is a <em>service message</em> – as is each pong. Each message is made of a <em>type</em> (like <code>application/vnd.awala.ping-v1.ping</code>) and its <em>content</em> (like the JSON document above). The content is binary so that you can transmit textual and binary data.</p>
<p>A service message isn&#39;t transmitted as is: Instead, it&#39;s encrypted and put inside a <em>parcel</em>, which contains just enough information for gateways to route it and ensure that only pre-authorised messages are delivered. Your app will be responsible for (un)sealing parcels using a high-level library.</p>
<h2 is-upgraded>Deserialise service messages</h2>
<p>Let&#39;s implement the code to extract the service message from incoming parcels and make sure that the contents are valid ping messages.</p>
<p>First, install the Awala Node.js library:</p>
<pre><code language="language-shell" class="language-shell">npm install @relaycorp/relaynet-core
</code></pre>
<p>You&#39;re going to need to convert <code>Buffer</code> values to <code>ArrayBuffer</code> a few times, so now create a utility to do just that. Create the file <code>src/utils.ts</code> with the following contents:</p>
<pre><code language="language-typescript" class="language-typescript">export function bufferToArrayBuffer(buffer: Buffer): ArrayBuffer {
    return buffer.buffer
        .slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength);
}
</code></pre>
<p>At this point you&#39;re ready to process incoming parcels, so you&#39;re going to implement a function that returns the encapsulated ping message after doing the following:</p>
<ol type="1">
<li>Decrypt the service message contained in a parcel using the private key you generated earlier.</li>
<li>Verify that the service message is syntactically valid and its <code>type</code> is that of a ping (i.e., <code>application/vnd.awala.ping-v1.ping</code>).</li>
<li>Parse the <code>content</code> of the service message and check it&#39;s a valid ping.</li>
</ol>
<p>To achieve this, create the file <code>src/messaging.ts</code> with the following contents:</p>
<pre><code language="language-typescript" class="language-typescript">import { Certificate, Parcel } from &#34;@relaycorp/relaynet-core&#34;;

import { bufferToArrayBuffer } from &#34;./utils&#34;;

export interface Ping {
  id: string;
  pda: Certificate;
  pdaChain: Certificate[];
}

export async function extractPingFromParcel(parcel: Parcel, privateKey: CryptoKey): Promise&lt;Ping&gt; {
  const { payload: serviceMessage } = await parcel.unwrapPayload(privateKey);
  if (serviceMessage.type !== &#39;application/vnd.awala.ping-v1.ping&#39;) {
    throw new Error(`Invalid service message type: ${serviceMessage.type}`);
  }
  return deserializePing(serviceMessage.content);
}

function deserializePing(pingSerialized: Buffer): Ping {
  const pingJson = JSON.parse(pingSerialized.toString());

  if (typeof pingJson.id !== &#39;string&#39;) {
    throw new Error(&#39;Ping id is missing or it is not a string&#39;);
  }

  let pda: Certificate;
  try {
    pda = deserializeCertificate(pingJson.pda);
  } catch (err) {
    throw new Error(`Invalid PDA: ${err.message}`);
  }

  if (!Array.isArray(pingJson.pda_chain)) {
    throw new Error(&#39;PDA chain is not an array&#39;);
  }
  let pdaChain: Certificate[];
  try {
    pdaChain = pingJson.pda_chain.map(deserializeCertificate);
  } catch (err) {
    throw new Error(`PDA chain contains invalid item: ${err.message}`);
  }

  return { id: pingJson.id, pda, pdaChain };
}

function deserializeCertificate(certificateDerBase64: any): Certificate {
  if (typeof certificateDerBase64 !== &#39;string&#39;) {
    throw new Error(&#39;Certificate is missing&#39;);
  }

  const certificateDer = Buffer.from(certificateDerBase64, &#39;base64&#39;);
  if (certificateDer.byteLength === 0) {
    throw new Error(&#39;Certificate is not base64-encoded&#39;);
  }

  try {
    return Certificate.deserialize(bufferToArrayBuffer(certificateDer));
  } catch (error) {
    throw new Error(&#39;Certificate is base64-encoded but not DER-encoded&#39;);
  }
}
</code></pre>
<p>Positive : Heads up: To improve security, <a href="https://github.com/relaycorp/relayverse/issues/27" target="_blank">Awala will support encryption with a different set of keys</a>, instead of using identity keys (which should ideally only be used for authentication and authorisation). <a href="https://github.com/AwalaNetwork/specs/issues/84" target="_blank">The ability to encrypt with identity keys will be dropped</a> before Awala reaches General Availability.</p>
<h2 is-upgraded>Create a Fastify route</h2>
<p>Gateways and public endpoints exchange parcels using <a href="https://specs.awala.network/RS-007" target="_blank">Awala PoHTTP</a>, which is a simple WebHook-based protocol. You might want to refer to the PoHTTP spec when you&#39;re eventually building the production version of a public endpoint, but for now that won&#39;t be necessary.</p>
<p>PoHTTP requires your server to receive parcels <code>POST</code>ed at <code>/</code>, so you&#39;re now going to create a Fastify route for <code>POST /</code>. This route will be responsible for the following:</p>
<ul>
<li>Validate the request, and abort with the appropriate <code>4XX</code> response if the request is invalid.</li>
<li>Return a <code>50X</code> response if there&#39;s an unexpected error at any point. That will instruct the gateway to try again later.</li>
<li>Return a <code>202 Accepted</code> response if the request is valid, regardless of whether the encapsulated service message was valid.</li>
</ul>
<p>To implement the above, create the file <code>src/routes/pohttp.ts</code> with the following contents:</p>
<pre><code language="language-typescript" class="language-typescript">import { derDeserializeRSAPrivateKey, Parcel } from &#34;@relaycorp/relaynet-core&#34;;
import { FastifyInstance } from &#34;fastify&#34;;
import * as process from &#34;process&#34;;
import fs from &#39;fs&#39;;
import { dirname, join } from &#39;path&#39;;

import { extractPingFromParcel, Ping } from &#34;../messaging&#34;;
import { bufferToArrayBuffer } from &#34;../utils&#34;;

const ROOT_DIR = dirname(dirname(__dirname));
const PRIVATE_KEY_PATH = join(ROOT_DIR, &#39;private-key.der&#39;);

export default async function registerRoutes(
  fastify: FastifyInstance,
  _options: any,
): Promise&lt;void&gt; {
  const privateKeySerialized = await fs.promises.readFile(PRIVATE_KEY_PATH);
  const privateKey = await derDeserializeRSAPrivateKey(privateKeySerialized);

  // Enable the request content type &#34;application/vnd.awala.parcel&#34;
  fastify.addContentTypeParser(
    &#39;application/vnd.awala.parcel&#39;,
    { parseAs: &#39;buffer&#39; },
    async (_req: any, buffer: Buffer) =&gt; {
      return bufferToArrayBuffer(buffer);
    },
  );

  fastify.route&lt;{ readonly Body: Buffer }&gt;({
    method: [&#39;POST&#39;],
    url: &#39;/&#39;,
    async handler(request, reply): Promise&lt;void&gt; {
      // Validate the request
      if (request.headers[&#39;content-type&#39;] !== &#39;application/vnd.awala.parcel&#39;) {
        return reply.code(415).send({ message: &#39;Invalid Content-Type&#39; });
      }
      const gatewayAddress = request.headers[&#39;x-awala-gateway&#39;] || &#39;&#39;;
      if (gatewayAddress.length === 0) {
        return reply
          .code(400)
          .send({ message: &#39;X-Awala-Gateway header is missing&#39; });
      }

      // Validate the parcel
      let parcel;
      try {
        parcel = await Parcel.deserialize(request.body);
        await parcel.validate();
      } catch (err) {
        request.log.info({ err }, &#39;Refusing malformed or invalid parcel&#39;);
        return reply.code(403).send({ message: &#39;Parcel is malformed or invalid&#39; });
      }
      if (parcel.recipientAddress !== `https://${process.env.PUBLIC_ADDRESS}`) {
        request.log.info(
          { recipient: parcel.recipientAddress },
          &#39;Refusing parcel bound for another endpoint&#39;
        );
        return reply.code(403).send({ message: &#39;Invalid parcel recipient&#39; });
      }

      // Get the ping message
      let ping: Ping;
      try {
        ping = await extractPingFromParcel(parcel, privateKey);
      } catch (err) {
        request.log.info(
          { err },
          &#39;Ignoring invalid/malformed service message or ping&#39;
        );
        // Don&#39;t return a 40X because the gateway did nothing wrong
        return reply.code(202).send({});
      }

      return reply.code(202).send({});
    },
  });
}
</code></pre>
<p>Negative : Unlike private endpoints, <strong>public endpoints are not protected against replay attacks</strong>, so a malicious gateway could send the same parcel multiple times. This would be a problem in most cases, but you can avoid it by storing the <code>parcel.id</code> and the private address of the sender (<code>parcel.senderCertificate.calculateSubjectPrivateAddress()</code>), and refusing any future parcels matching those. You only need to keep that data around until <code>parcel.expiryDate</code>.</p>
<h2 is-upgraded>Test the new route</h2>
<p>Make sure that the new route is working fine by starting the server locally (<code>npm start:dev</code>) and making a <code>POST</code> request to it. For example, on Linux/macOS, you can run:</p>
<pre><code language="language-shell" class="language-shell">curl -X POST \
  -H &#39;X-Awala-Gateway: foo.bar&#39; \
  -H &#39;Content-Type: application/vnd.awala.parcel&#39; \
  http://127.0.0.1:8080
</code></pre>
<p>Which should return the following:</p>
<pre><code language="language-json" class="language-json">{&#34;message&#34;:&#34;Parcel is malformed or invalid&#34;}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Send pongs" duration="5">
        <p>It&#39;s time to send pong messages back, now that you&#39;re able to receive pings.</p>
<h2 is-upgraded>Create parcels for pong messages</h2>
<p>Serialising pong messages is really simple, as the message content is just a string representing their respective ping id. It doesn&#39;t use JSON.</p>
<p>Once the pong service message is serialised, the next step is to put it inside a parcel by:</p>
<ol type="1">
<li>Putting the encrypted service message in the parcel.</li>
<li>Attaching the PDA and its chain to the parcel.</li>
<li>Signing the parcel with the public endpoint&#39;s identity key.</li>
</ol>
<p>To do this, go back to <code>src/messaging.ts</code> and add the following function:</p>
<pre><code language="language-typescript" class="language-typescript">export async function createPongParcel(
  ping: Ping,
  pingSenderCertificate: Certificate,
  privateKey: CryptoKey,
): Promise&lt;Buffer&gt; {
  const pongMessage = new ServiceMessage(
    &#39;application/vnd.awala.ping-v1.pong&#39;,
    Buffer.from(ping.id),
  );
  const pongParcelPayload = await SessionlessEnvelopedData.encrypt(
    pongMessage.serialize(),
    pingSenderCertificate,
  );
  const pongParcel = new Parcel(
    await pingSenderCertificate.calculateSubjectPrivateAddress(),
    ping.pda,
    Buffer.from(pongParcelPayload.serialize()),
    { senderCaCertificateChain: ping.pdaChain },
  );
  return Buffer.from(await pongParcel.serialize(privateKey));
}
</code></pre>
<p>Make sure to add the missing imports from <code>@relaycorp/relaynet-core</code>.</p>
<h2 is-upgraded>Send parcels to the public gateway</h2>
<p>For expediency, you&#39;re going to send the parcel containing the pong message within the same process, before returning the HTTP response. However, you should consider using a background queue in production, such as one backed by <a href="https://www.npmjs.com/package/bull" target="_blank">Redis</a> or <a href="https://cloud.google.com/pubsub" target="_blank">GCP PubSub</a>.</p>
<p>First, you should install the PoHTTP client so that you can send parcels to public gateways:</p>
<pre><code language="language-shell" class="language-shell">npm install @relaycorp/relaynet-pohttp
</code></pre>
<p>Then open <code>src/routes/pohttp.ts</code> and add the following before the last <code>return</code> statement in the route:</p>
<pre><code language="language-typescript" class="language-typescript">// Send the pong message
const pongParcel =
  await createPongParcel(ping, parcel.senderCertificate, privateKey);
try {
  await deliverParcel(gatewayAddress as string, pongParcel);
} catch (err) {
  request.log.error({ err, gatewayAddress }, &#39;Failed to send pong&#39;);
  return reply.code(500).send({ message: &#39;Internal server error&#39; });
}
</code></pre>
<p>Finally, import the <code>createPongParcel()</code> function at the top of the file.</p>
<h2 is-upgraded>Deploy the latest changes to GAE</h2>
<p>Make sure that nothing is broken by starting the server locally (<code>npm start:dev</code>) and making a POST request to <code>http://127.0.0.1:8080</code>. For example, on Linux/macOS, you can run:</p>
<pre><code language="language-shell" class="language-shell">curl -X POST \
  -H &#39;X-Awala-Gateway: foo.bar&#39; \
  -H &#39;Content-Type: application/vnd.awala.parcel&#39; \
  http://127.0.0.1:8080
</code></pre>
<p>If you&#39;re still getting <code>Parcel is malformed or invalid</code>, that&#39;s good, so deploy the latest changes by running the following command:</p>
<pre><code language="language-shell" class="language-shell">gcloud app deploy
</code></pre>
<p>For good measure, make the same POST request, but this time to the <code>appspot.com</code> URL. You should get the exact same response.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Test your endpoint" duration="5">
        <p>It&#39;s finally time to test your public endpoint, and you&#39;ll use <a href="https://www.npmjs.com/package/@relaycorp/awala-ping" target="_blank"><code>awala-ping</code></a> for that.</p>
<h2 is-upgraded>Install <code>awala-ping</code></h2>
<p>To install the app, simply run:</p>
<pre><code language="language-shell" class="language-shell">npm install -g @relaycorp/awala-ping
</code></pre>
<p>Make sure that it&#39;s working properly by pinging <code>ping.awala.services</code>, so start the <a href="https://awala.network/users/download" target="_blank">private gateway</a> (if it isn&#39;t running already) and run the following:</p>
<pre><code language="language-shell" class="language-shell">awala-ping ping
</code></pre>
<p>You&#39;ll see a message saying that a ping message was sent and another saying that the pong message was received.</p>
<h2 is-upgraded>Import your endpoint</h2>
<p>You need to import your endpoint with <code>awala-ping</code> so that you can use it. The public endpoint <code>ping.awala.services</code> works straightaway because it&#39;s imported automatically the first time you use <code>awala-ping</code>.</p>
<p>To import your public endpoint, you should call <code>awala-ping third-party-endpoints import-public</code> with your endpoint&#39;s identity certificate and its public address. For example:</p>
<pre><code language="language-shell" class="language-shell">awala-ping third-party-endpoints import-public \
  pong-codelab.awala.services \
  &lt; identity-certificate.der
</code></pre>
<h2 is-upgraded>Test it!</h2>
<p>You&#39;re now ready to call <code>awala-ping ping</code> with your public endpoint! For example:</p>
<pre><code language="language-shell" class="language-shell">awala-ping ping pong-codelab.awala.services
</code></pre>
<p>If you&#39;re not getting a message saying that a ping was sent, make sure that the private gateway is indeed running.</p>
<p>If pings are sent, but you never get pongs, try the following:</p>
<ul>
<li>Make sure that your GAE app is getting pings and sending pongs by checking <a href="https://console.cloud.google.com/logs/query" target="_blank">its logs</a>. If it&#39;s failing to process pings or send pongs, you&#39;ll find the reason in those logs.</li>
<li>If your GAE app isn&#39;t even getting pings, check that the SRV record you created earlier is working by going to <a href="https://dnschecker.org/#SRV/_awala-pdc._tcp.ping.awala.services" target="_blank">dnschecker.org</a> (replace <code>ping.awala.services</code> with the public address of your endpoint). If it doesn&#39;t look right, check with your DNS hosting provider and/or registrar.</li>
<li>If the above looks good but you&#39;re still not getting pongs, <a href="https://community.awala.network/c/service-providers/6" target="_blank">let us know</a>.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="That&#39;s it!" duration="5">
        <p>Well done! You&#39;ve just built an Android app for a centralised Awala service.</p>
<h2 is-upgraded>Delete the GCP project</h2>
<p>When you&#39;re done testing the public endpoint you created, do the following to delete the resources you created:</p>
<p>Negative : If you created additional GCP resources in this project, those will be deleted too.</p>
<ol type="1">
<li>Go to the <a href="https://console.cloud.google.com/cloud-resource-manager" target="_blank">GCP resource manager</a>.</li>
<li>In the project list, select the project that you want to delete, and then click <em>Delete</em>.</li>
<li>In the dialog, type the project ID, and then click <em>Shut down</em> to delete the project.</li>
</ol>
<h2 is-upgraded>What&#39;s next?</h2>
<ul>
<li>Learn more about the <a href="https://awala.network/service-providers/implementation/architecture" target="_blank">architecture of Awala services</a>.</li>
<li>Read the <a href="https://docs.relaycorp.tech/relaynet-core-js/" target="_blank">documentation for the Awala Node.js library</a>.</li>
<li><a href="https://community.awala.network/" target="_blank">Join the Awala community</a> and give us some feedback on the codelab.</li>
<li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fawala.network%2Fservice-providers%2F&via=AwalaNetwork&text=I%27ve%20just%20built%20an%20app%20that%20can%20sync%20with%20the%20Internet%20even%20if%20the%20user%20is%20disconnected%20from%20it%21" target="_blank">Spread the word on Twitter!</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
